import React, { useRef, useState, useEffect } from 'react';
import { motion } from 'framer-motion';

// Full 5x7 bitmap font for ASCII characters 32-126 (printable)
const font5x7Data = {
  ' ': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
  '!': [0x04, 0x04, 0x04, 0x04, 0x00, 0x00, 0x04],
  '"': [0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00],
  '#': [0x0A, 0x0A, 0x1F, 0x0A, 0x1F, 0x0A, 0x0A],
  '$': [0x04, 0x0F, 0x14, 0x0E, 0x05, 0x1E, 0x04],
  '%': [0x11, 0x12, 0x04, 0x08, 0x13, 0x09, 0x11],
  '&': [0x0C, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0D],
  "'": [0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00],
  '(': [0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02],
  ')': [0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08],
  '*': [0x00, 0x04, 0x15, 0x0E, 0x15, 0x04, 0x00],
  '+': [0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00],
  ',': [0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x08],
  '-': [0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00],
  '.': [0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00],
  '/': [0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00],
  '0': [0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
  '1': [0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E],
  '2': [0x0E, 0x11, 0x01, 0x06, 0x08, 0x10, 0x1F],
  '3': [0x0E, 0x11, 0x01, 0x06, 0x01, 0x11, 0x0E],
  '4': [0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02],
  '5': [0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E],
  '6': [0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E],
  '7': [0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08],
  '8': [0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E],
  '9': [0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C],
  ':': [0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00],
  ';': [0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x08],
  '<': [0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02],
  '=': [0x00, 0x00, 0x1F, 0x00, 0x1F, 0x00, 0x00],
  '>': [0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08],
  '?': [0x0E, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04],
  '@': [0x0E, 0x11, 0x15, 0x16, 0x10, 0x11, 0x0E],
  'A': [0x0E, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],
  'B': [0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E],
  'C': [0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E],
  'D': [0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C],
  'E': [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F],
  'F': [0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10],
  'G': [0x0E, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0E],
  'H': [0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11],
  'I': [0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E],
  'J': [0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0C],
  'K': [0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11],
  'L': [0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F],
  'M': [0x11, 0x1B, 0x15, 0x11, 0x11, 0x11, 0x11],
  'N': [0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x11],
  'O': [0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
  'P': [0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10],
  'Q': [0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D],
  'R': [0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11],
  'S': [0x0E, 0x11, 0x10, 0x0E, 0x01, 0x11, 0x0E],
  'T': [0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04],
  'U': [0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E],
  'V': [0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04],
  'W': [0x11, 0x11, 0x11, 0x15, 0x15, 0x0A, 0x11],
  'X': [0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11],
  'Y': [0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04],
  'Z': [0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F],
  '[': [0x0E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0E],
  '\\': [0x10, 0x08, 0x04, 0x02, 0x01, 0x00, 0x00],
  ']': [0x0E, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0E],
  '^': [0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00],
  '_': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F],
  '`': [0x08, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00],
  'a': [0x00, 0x00, 0x0E, 0x01, 0x0F, 0x11, 0x0F],
  'b': [0x10, 0x10, 0x1E, 0x11, 0x11, 0x11, 0x1E],
  'c': [0x00, 0x00, 0x0F, 0x10, 0x10, 0x10, 0x0F],
  'd': [0x01, 0x01, 0x0F, 0x11, 0x11, 0x11, 0x0F],
  'e': [0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E],
  'f': [0x06, 0x08, 0x1C, 0x08, 0x08, 0x08, 0x08],
  'g': [0x00, 0x00, 0x0F, 0x11, 0x0F, 0x01, 0x0E],
  'h': [0x10, 0x10, 0x1E, 0x11, 0x11, 0x11, 0x11],
  'i': [0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x0E],
  'j': [0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0C],
  'k': [0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12],
  'l': [0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E],
  'm': [0x00, 0x00, 0x1A, 0x15, 0x15, 0x15, 0x15],
  'n': [0x00, 0x00, 0x1E, 0x11, 0x11, 0x11, 0x11],
  'o': [0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E],
  'p': [0x00, 0x00, 0x1E, 0x11, 0x1E, 0x10, 0x10],
  'q': [0x00, 0x00, 0x0F, 0x11, 0x0F, 0x01, 0x01],
  'r': [0x00, 0x00, 0x1E, 0x11, 0x10, 0x10, 0x10],
  's': [0x00, 0x00, 0x0F, 0x10, 0x0E, 0x01, 0x1E],
  't': [0x08, 0x08, 0x1C, 0x08, 0x08, 0x08, 0x06],
  'u': [0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x0E],
  'v': [0x00, 0x00, 0x11, 0x11, 0x11, 0x0A, 0x04],
  'w': [0x00, 0x00, 0x11, 0x15, 0x15, 0x15, 0x0A],
  'x': [0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11],
  'y': [0x00, 0x00, 0x11, 0x11, 0x0F, 0x01, 0x0E],
  'z': [0x00, 0x00, 0x1F, 0x02, 0x04, 0x08, 0x1F],
  '{': [0x06, 0x08, 0x08, 0x10, 0x08, 0x08, 0x06],
  '|': [0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04],
  '}': [0x0C, 0x02, 0x02, 0x01, 0x02, 0x02, 0x0C],
  '~': [0x00, 0x00, 0x08, 0x15, 0x02, 0x00, 0x00]
};

// Convert hex column to 5x7 bitmap array
const hexToBitmap = (hexArray) => {
  const bitmap = Array(7).fill().map(() => Array(5).fill(0));
  for (let y = 0; y < 7; y++) {
    const bits = hexArray[y].toString(2).padStart(5, '0');
    for (let x = 0; x < 5; x++) {
      bitmap[y][x] = bits[x] === '1' ? 1 : 0;
    }
  }
  return bitmap;
};

const DisplayPage = () => {
  const canvasRef = useRef(null);
  const [text, setText] = useState('Hello World');
  const [displayLines, setDisplayLines] = useState(['Hello World']);
  const bitmapCache = useRef({});

  useEffect(() => {
    // Split input text into lines of 21 characters
    const maxCharsPerLine = 21;
    const lines = [];
    let currentLine = '';
    for (let char of text) {
      if (currentLine.length < maxCharsPerLine) {
        currentLine += char;
      } else {
        lines.push(currentLine);
        currentLine = char;
      }
    }
    if (currentLine) {
      lines.push(currentLine);
    }
    setDisplayLines(lines.slice(-8));
  }, [text]);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;

      const pixelSize = 3.54;
      const gap = 0.4;
      const pixelWithGap = pixelSize + gap;

      ctx.fillStyle = '#c0d8c0';
      for (let y = 0; y < 64; y++) {
        for (let x = 0; x < 128; x++) {
          ctx.fillRect(x * pixelWithGap, y * pixelWithGap, pixelSize, pixelSize);
        }
      }

      for (let lineIndex = 0; lineIndex < Math.min(displayLines.length, 8); lineIndex++) {
        const line = displayLines[lineIndex];
        let xOffset = 0;
        for (let char of line) {
          if (!bitmapCache.current[char] && font5x7Data[char]) {
            bitmapCache.current[char] = hexToBitmap(font5x7Data[char]);
          }
          const bitmap = bitmapCache.current[char] || hexToBitmap(font5x7Data[' ']);
          for (let y = 0; y < 7; y++) {
            for (let x = 0; x < 5; x++) {
              ctx.fillStyle = bitmap[y][x] ? '#000000' : '#c0d8c0';
              ctx.fillRect(
                xOffset + x * pixelWithGap,
                lineIndex * 7 * pixelWithGap + y * pixelWithGap,
                pixelSize,
                pixelSize
              );
            }
          }
          xOffset += 6 * pixelWithGap;
        }
      }
      console.log(`DisplayPage: Rendered ${displayLines.length} lines on ST7565 simulator:`, displayLines);
    }
  }, [displayLines]);

  const handleInputChange = (e) => {
    const newText = e.target.value;
    setText(newText);
  };

  return (
    <motion.div
      className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 pt-16 flex items-center justify-center"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.5 }}
    >
      <div className="border border-blue-200 border-1 flex flex-col items-center">
        <h1 className="text-sm font-semibold text-blue-800 mb-2 text-center">ST7565 Display (128x64)</h1>
        <canvas
          ref={canvasRef}
          width={128 * (3.54 + 0.4)}
          height={64 * (3.54 + 0.4)}
          style={{ width: '453.6px', height: '226.8px' }}
          className="bg-transparent mb-4"
        ></canvas>
        <input
          type="text"
          value={text}
          onChange={handleInputChange}
          placeholder="Type text to display"
          maxLength={21 * 8}
          className="w-64 px-3 py-2 text-sm text-blue-800 bg-white border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
      </div>
    </motion.div>
  );
};

export default DisplayPage;